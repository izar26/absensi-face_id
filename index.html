<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Face ID (Fitur Lanjutan)</title>
    
    <link rel="manifest" id="manifest">
    <meta name="theme-color" content="#1f2937"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1f2937/ffffff?text=Absen">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4 / 3;
            margin: 0 auto;
            background-color: #111827;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
        #video {
            object-fit: cover;
            transform: scaleX(-1);
        }
        .feedback-box {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 8px;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            z-index: 20;
            transition: opacity 0.3s ease;
        }
        #success-modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        @media print {
            body > *:not(.printable-area) { display: none; }
            .printable-area, .printable-area #page-laporan { display: block !important; visibility: visible; }
            .no-print { display: none !important; }
            body, .bg-gray-800 { background-color: white !important; color: black !important; }
            h2, th, td { color: black !important; }
            thead { background-color: #eee !important; }
            tr { border-bottom: 1px solid #ccc; }
            #laporan-container { box-shadow: none; border: 1px solid #ccc; }
            .status-override-select { display: none; }
            .status-print-only { display: inline !important; }
        }
        .status-print-only { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-gray-800 rounded-lg shadow-xl p-6 printable-area">
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-cyan-400">Sistem Absensi Pengenalan Wajah</h1>
            <p class="text-gray-400">Dilengkapi Deteksi Kehidupan (Senyum) & Umpan Balik Kualitas.</p>
        </header>

        <nav class="flex justify-center flex-wrap gap-2 sm:space-x-4 mb-6 border-b border-gray-700 pb-4 no-print">
            <button id="nav-absensi" class="nav-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Absensi</button>
            <button id="nav-registrasi" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Registrasi</button>
            <button id="nav-peserta" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Daftar Peserta</button>
            <button id="nav-jadwal" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Buat Sesi</button>
            <button id="nav-sesi-list" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Daftar Sesi</button>
            <button id="nav-laporan" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Laporan</button>
            <button id="nav-grafik" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Grafik</button>
        </nav>

        <main>
            <!-- Halaman Absensi -->
            <div id="page-absensi" class="page">
                 <div class="mb-4">
                    <label for="session-selector" class="block mb-2 text-sm font-medium text-gray-300">Pilih Sesi Aktif Hari Ini:</label>
                    <select id="session-selector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5"></select>
                </div>
                <div class="video-container mb-4">
                    <div id="camera-placeholder-absensi" class="flex items-center justify-center h-full"><p>Pilih sesi untuk mengaktifkan kamera</p></div>
                </div>
                <div id="status-container" class="text-center p-4 rounded-lg bg-gray-700 min-h-[80px] flex items-center justify-center mb-4">
                    <p id="status" class="text-lg">Menginisialisasi model...</p>
                </div>
            </div>

            <!-- Halaman Registrasi -->
            <div id="page-registrasi" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Registrasi Wajah Baru</h2>
                <div class="video-container mb-4">
                     <div id="camera-placeholder-registrasi" class="flex items-center justify-center h-full"><p>Kamera akan aktif di sini</p></div>
                </div>
                 <div class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label for="namaLengkap" class="block mb-2 text-sm font-medium text-gray-300">Nama Lengkap</label>
                        <input type="text" id="namaLengkap" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5" placeholder="Contoh: Budi Sanjaya" required>
                    </div>
                    <button id="register-btn" class="w-full action-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-300">Mulai Registrasi</button>
                    <div id="register-status" class="text-center mt-4 p-3 rounded-lg min-h-[50px]"></div>
                </div>
            </div>

            <!-- Halaman Jadwal Sesi -->
            <div id="page-jadwal" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Buat Jadwal Sesi Baru</h2>
                <div class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label for="session-date" class="block mb-2 text-sm font-medium text-gray-300">Tanggal Sesi</label>
                        <input type="date" id="session-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="session-start-time" class="block mb-2 text-sm font-medium text-gray-300">Jam Mulai</label>
                            <input type="time" id="session-start-time" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="session-end-time" class="block mb-2 text-sm font-medium text-gray-300">Jam Selesai</label>
                            <input type="time" id="session-end-time" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">Semua peserta yang terdaftar akan otomatis dimasukkan ke dalam sesi ini.</p>
                    <button id="create-session-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Buat Sesi</button>
                    <div id="session-status" class="text-center mt-4 p-3 rounded-lg min-h-[50px]"></div>
                </div>
            </div>

            <!-- Halaman Daftar Sesi -->
            <div id="page-sesi-list" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Daftar Semua Sesi</h2>
                <div id="session-list-container" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>

             <!-- Halaman Grafik -->
            <div id="page-grafik" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Analisis Kehadiran</h2>
                <div class="mb-6">
                    <label for="grafik-session-filter" class="block mb-2 text-sm font-medium text-gray-300">Pilih Sesi untuk Ringkasan:</label>
                    <select id="grafik-session-filter" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5"></select>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg mb-6">
                    <canvas id="summaryChart"></canvas>
                </div>
                <h3 class="text-xl font-semibold text-center mb-4 text-cyan-400">Peringkat Disiplin (Total Poin Tepat Waktu)</h3>
                <div id="performance-leaderboard-container" class="space-y-2"></div>
            </div>

            <!-- Halaman Daftar Peserta -->
            <div id="page-peserta" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Daftar Peserta Terdaftar</h2>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nama</th>
                                <th scope="col" class="py-3 px-6 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="peserta-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Halaman Laporan -->
            <div id="page-laporan" class="page hidden">
                <h2 id="laporan-title" class="text-2xl font-semibold text-center mb-4 text-cyan-400">Laporan Kehadiran</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 no-print">
                    <div class="w-full sm:w-auto">
                        <label for="report-session-filter" class="sr-only">Filter Sesi:</label>
                        <select id="report-session-filter" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5"></select>
                    </div>
                    <div class="flex space-x-2">
                        <button id="print-laporan" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Print Laporan</button>
                    </div>
                </div>
                <div id="laporan-container" class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nama</th>
                                <th scope="col" class="py-3 px-6">Status</th>
                                <th scope="col" class="py-3 px-6">Waktu Absen</th>
                                <th scope="col" class="py-3 px-6">Keterangan</th>
                                <th scope="col" class="py-3 px-6 text-right no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Elemen Global -->
    <div id="global-video-container" style="display: none;">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <div id="feedback-box" class="feedback-box opacity-0"></div>
        <button id="switch-camera-btn" class="absolute top-2 right-2 bg-gray-800 bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 z-10 hidden" title="Ganti Kamera">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20L20 4M20 4v5h-5M4 4h5v5"></path></svg>
        </button>
    </div>

    <!-- Modal Sukses Absensi -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none transform scale-95">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-8 text-center border-2 border-green-500">
            <img id="success-photo" src="https://placehold.co/150x150/1f2937/ffffff?text=Foto" class="w-36 h-36 rounded-full mx-auto mb-4 border-4 border-gray-600 object-cover">
            <h3 id="success-name" class="text-2xl font-bold text-white mb-1">Nama Peserta</h3>
            <p class="text-green-400 font-semibold text-lg mb-2">Absensi Berhasil!</p>
            <p id="success-time" class="text-gray-400">Pada pukul 00:00:00</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elemen DOM ---
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const context = overlay.getContext('2d');
            const statusEl = document.getElementById('status');
            const registerStatusEl = document.getElementById('register-status');
            const registerBtn = document.getElementById('register-btn');
            const sessionSelector = document.getElementById('session-selector');
            const feedbackBox = document.getElementById('feedback-box');
            const successModal = document.getElementById('success-modal');
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            const laporanBody = document.getElementById('laporan-body');
            const pesertaBody = document.getElementById('peserta-body');
            const sessionDateEl = document.getElementById('session-date');
            const sessionStartTimeEl = document.getElementById('session-start-time');
            const sessionEndTimeEl = document.getElementById('session-end-time');
            const createSessionBtn = document.getElementById('create-session-btn');
            const sessionStatusEl = document.getElementById('session-status');
            const reportSessionFilter = document.getElementById('report-session-filter');
            const printLaporanBtn = document.getElementById('print-laporan');
            const sessionListContainer = document.getElementById('session-list-container');
            const grafikSessionFilter = document.getElementById('grafik-session-filter');
            const performanceLeaderboardContainer = document.getElementById('performance-leaderboard-container');
            let summaryChart = null;

            // --- Variabel State ---
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            let currentStream = null;
            let facingMode = 'user';
            let detectionInterval;
            let currentAppMode = 'idle'; // 'idle', 'registering', 'recognizing', 'liveness_check'
            let registrationState = { samples: [], bestSamplePhoto: null };
            let recognitionState = { name: null, count: 0, user: null };
            let livenessState = { user: null, timeout: null };
            let attendedThisSession = [];

            const SAMPLES_REQUIRED = 3;
            const RECOGNITION_CONFIRMATION_COUNT = 5; // ~2 detik
            const LIVENESS_TIMEOUT_MS = 5000; // 5 detik untuk senyum

            // --- Fungsi Notifikasi Suara ---
            function speak(text) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                window.speechSynthesis.speak(utterance);
            }

            // --- Setup PWA ---
            function setupPWA() {
                const manifestData = {
                    "name": "Aplikasi Absensi Wajah", "short_name": "Absen Wajah", "start_url": ".", "display": "standalone",
                    "background_color": "#1f2937", "theme_color": "#1f2937", "description": "Aplikasi absensi dengan pengenalan wajah.",
                    "icons": [
                        { "src": "https://placehold.co/192x192/1f2937/ffffff?text=Absen", "type": "image/png", "sizes": "192x192" },
                        { "src": "https://placehold.co/512x512/1f2937/ffffff?text=Absen", "type": "image/png", "sizes": "512x512" }
                    ]
                };
                const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifest').setAttribute('href', manifestURL);
            }

            // --- Inisialisasi Aplikasi ---
            async function initialize() {
                try {
                    statusEl.innerText = 'Memuat model...';
                    await Promise.all([
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                        faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                    ]);
                    setupPWA();
                    switchPage('page-absensi');
                } catch (error) {
                    console.error("Gagal memuat model:", error);
                    statusEl.innerText = 'Error: Gagal memuat model.';
                }
            }

            // --- Fungsi Webcam & Deteksi Wajah ---
            function stopWebcam() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                clearInterval(detectionInterval);
                detectionInterval = null;
                video.classList.add('hidden');
                overlay.classList.add('hidden');
                feedbackBox.classList.add('opacity-0');
                currentAppMode = 'idle';
            }

            async function startWebcam(containerElement) {
                if (currentStream || !containerElement) return;
                try {
                    containerElement.append(video, overlay, document.getElementById('switch-camera-btn'), feedbackBox);
                    video.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
                    video.srcObject = stream;
                    currentStream = stream;

                    video.onloadedmetadata = () => {
                        faceapi.matchDimensions(overlay, { width: video.clientWidth, height: video.clientHeight });
                        detectionInterval = setInterval(mainDetectionLoop, 400);
                    };
                } catch (error) {
                    console.error("Gagal mengakses webcam:", error);
                }
            }

            async function mainDetectionLoop() {
                if (video.paused || video.ended || !currentStream) return;

                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                    .withFaceLandmarks()
                    .withFaceExpressions()
                    .withFaceDescriptor();
                
                context.clearRect(0, 0, overlay.width, overlay.height);
                if (detection) {
                    const resizedDetection = faceapi.resizeResults(detection, { width: video.clientWidth, height: video.clientHeight });
                    faceapi.draw.drawDetections(overlay, resizedDetection);
                }

                const qualityFeedback = getQualityFeedback(detection);
                updateFeedbackBox(qualityFeedback.message);

                switch (currentAppMode) {
                    case 'registering':
                        handleRegistration(detection, qualityFeedback.isGood);
                        break;
                    case 'recognizing':
                        handleRecognition(detection);
                        break;
                    case 'liveness_check':
                        handleLivenessCheck(detection);
                        break;
                }
            }

            // --- Umpan Balik Kualitas ---
            function getQualityFeedback(detection) {
                if (!detection) return { isGood: false, message: 'Wajah tidak terdeteksi' };
                const { box } = detection.detection;
                if (box.width < 100) return { isGood: false, message: 'Terlalu jauh' };
                const landmarks = detection.landmarks;
                const eyeAngle = Math.atan2(landmarks.getRightEye()[0].y - landmarks.getLeftEye()[0].y, landmarks.getRightEye()[0].x - landmarks.getLeftEye()[0].x) * 180 / Math.PI;
                if (Math.abs(eyeAngle) > 10) return { isGood: false, message: 'Posisikan wajah lebih lurus' };
                return { isGood: true, message: 'Kualitas bagus!' };
            }

            function updateFeedbackBox(message) {
                if (message) {
                    feedbackBox.innerText = message;
                    feedbackBox.classList.remove('opacity-0');
                } else {
                    feedbackBox.classList.add('opacity-0');
                }
            }

            // --- Logika Registrasi ---
            registerBtn.addEventListener('click', () => {
                const namaLengkap = document.getElementById('namaLengkap').value.trim();
                if (!namaLengkap) return showStatus(registerStatusEl, 'Nama harus diisi.', 'error');
                if (getRegisteredUsers().some(u => u.name.toLowerCase() === namaLengkap.toLowerCase())) {
                    return showStatus(registerStatusEl, `Nama "${namaLengkap}" sudah terdaftar.`, 'error');
                }
                currentAppMode = 'registering';
                registrationState = { samples: [], bestSamplePhoto: null };
                registerBtn.disabled = true;
            });

            function handleRegistration(detection, isGood) {
                const sampleCount = registrationState.samples.length;
                showStatus(registerStatusEl, `Mengambil sampel ${sampleCount + 1}/${SAMPLES_REQUIRED}...`);
                
                if (isGood && !window.takingSample) {
                    window.takingSample = true;
                    setTimeout(() => {
                        registrationState.samples.push(Array.from(detection.descriptor));
                        if (registrationState.samples.length === 2) {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            canvas.getContext('2d').drawImage(video, 0, 0);
                            registrationState.bestSamplePhoto = canvas.toDataURL('image/jpeg');
                        }
                        if (registrationState.samples.length >= SAMPLES_REQUIRED) finalizeRegistration();
                        window.takingSample = false;
                    }, 1000);
                }
            }

            function finalizeRegistration() {
                const namaLengkap = document.getElementById('namaLengkap').value.trim();
                const users = getRegisteredUsers();
                users.push({ 
                    name: namaLengkap, 
                    descriptors: registrationState.samples,
                    photo: registrationState.bestSamplePhoto
                });
                saveRegisteredUsers(users);
                showStatus(registerStatusEl, `Registrasi berhasil untuk ${namaLengkap}!`, 'success');
                speak(`Registrasi berhasil untuk ${namaLengkap}`);
                document.getElementById('namaLengkap').value = '';
                registerBtn.disabled = false;
                currentAppMode = 'idle';
            }

            // --- Logika Absensi ---
            async function handleRecognition(detection) {
                const sessionId = sessionSelector.value;
                if (!sessionId || !detection) {
                    recognitionState = { name: null, count: 0, user: null };
                    return;
                }
                
                const faceMatcher = await createFaceMatcher(sessionId);
                if (!faceMatcher) return;

                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                
                if (bestMatch.label === 'unknown' || attendedThisSession.includes(bestMatch.label)) {
                    showStatus(statusEl, 'Arahkan wajah ke kamera...');
                    recognitionState = { name: null, count: 0, user: null };
                    return;
                }

                if (recognitionState.name === bestMatch.label) {
                    recognitionState.count++;
                } else {
                    const user = getRegisteredUsers().find(u => u.name === bestMatch.label);
                    recognitionState = { name: bestMatch.label, count: 1, user: user };
                }

                showStatus(statusEl, `Halo, ${recognitionState.name}! Tahan posisi...`);

                if (recognitionState.count >= RECOGNITION_CONFIRMATION_COUNT) {
                    currentAppMode = 'liveness_check';
                    livenessState.user = recognitionState.user;
                    showStatus(statusEl, `Hai ${livenessState.user.name}, silakan tersenyum!`, 'warning');
                    speak("Silakan tersenyum");
                    
                    livenessState.timeout = setTimeout(() => {
                        if (currentAppMode === 'liveness_check') {
                            showStatus(statusEl, 'Waktu habis. Coba lagi.', 'error');
                            resetAttendanceState();
                        }
                    }, LIVENESS_TIMEOUT_MS);
                }
            }

            function handleLivenessCheck(detection) {
                if (!detection || !livenessState.user) return;
                
                if (detection.expressions.happy > 0.8) {
                    clearTimeout(livenessState.timeout);
                    const session = getSessions().find(s => s.id === sessionSelector.value);
                    recordAttendance(livenessState.user, session);
                    attendedThisSession.push(livenessState.user.name);
                    showSuccessModal(livenessState.user);
                    speak(`Absensi berhasil ${livenessState.user.name}`);
                    resetAttendanceState();
                }
            }
            
            function resetAttendanceState() {
                currentAppMode = 'recognizing';
                recognitionState = { name: null, count: 0, user: null };
                livenessState = { user: null, timeout: null };
                setTimeout(() => showStatus(statusEl, 'Arahkan wajah ke kamera...'), 3000);
            }

            function showSuccessModal(user) {
                document.getElementById('success-photo').src = user.photo;
                document.getElementById('success-name').innerText = user.name;
                document.getElementById('success-time').innerText = `Pada pukul ${new Date().toLocaleTimeString('id-ID')}`;
                successModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                setTimeout(() => {
                    successModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                }, 4000);
            }

            // --- Helper & Manajemen Data ---
            let faceMatcherCache = {};
            async function createFaceMatcher(sessionId) {
                if (faceMatcherCache[sessionId]) return faceMatcherCache[sessionId];
                const session = getSessions().find(s => s.id === sessionId);
                if (!session) return null;
                const participants = getRegisteredUsers().filter(u => session.participants.includes(u.name));
                if (participants.length === 0) return null;
                const labeledDescriptors = participants.map(p => new faceapi.LabeledFaceDescriptors(p.name, p.descriptors.map(d => new Float32Array(d))));
                faceMatcherCache[sessionId] = new faceapi.FaceMatcher(labeledDescriptors, 0.55);
                return faceMatcherCache[sessionId];
            }

            function getRegisteredUsers() { return JSON.parse(localStorage.getItem('faceAttendanceUsers_v3')) || []; }
            function saveRegisteredUsers(users) { localStorage.setItem('faceAttendanceUsers_v3', JSON.stringify(users)); }
            function getAttendanceLog() { return JSON.parse(localStorage.getItem('faceAttendanceLog')) || []; }
            function saveAttendanceLog(log) { localStorage.setItem('faceAttendanceLog', JSON.stringify(log)); }
            function getSessions() { return JSON.parse(localStorage.getItem('faceAttendanceSessions')) || []; }
            function saveSessions(sessions) { localStorage.setItem('faceAttendanceSessions', JSON.stringify(sessions)); }

            function recordAttendance(user, session) {
                const log = getAttendanceLog();
                const now = new Date();
                const deadline = new Date(`${session.date}T${session.startTime}`);
                const remark = now <= deadline ? 'Tepat Waktu' : 'Terlambat';
                log.push({ name: user.name, date: now.toISOString().split('T')[0], time: now.toLocaleTimeString('id-ID'), sessionId: session.id, remark: remark, status: 'Hadir' });
                saveAttendanceLog(log);
            }

            function showStatus(element, message, type = 'info') {
                element.innerText = message;
                const container = element.parentElement;
                container.className = 'text-center p-4 rounded-lg min-h-[80px] flex items-center justify-center mb-4';
                switch(type) {
                    case 'success': container.classList.add('bg-green-900', 'text-green-300'); break;
                    case 'error': container.classList.add('bg-red-900', 'text-red-300'); break;
                    case 'warning': container.classList.add('bg-yellow-900', 'text-yellow-300'); break;
                    default: container.classList.add('bg-gray-700');
                }
            }
            
            // --- Navigasi & Event Listeners ---
            sessionSelector.addEventListener('change', () => {
                const sessionId = sessionSelector.value;
                attendedThisSession = [];
                resetAttendanceState();
                const container = document.querySelector('#page-absensi .video-container');
                if (sessionId) {
                    currentAppMode = 'recognizing';
                    startWebcam(container);
                } else {
                    stopWebcam();
                }
            });

            function switchPage(targetPageId) {
                stopWebcam();
                pages.forEach(p => p.classList.add('hidden'));
                const targetPage = document.getElementById(targetPageId);
                if(targetPage) targetPage.classList.remove('hidden');

                navButtons.forEach(b => b.classList.replace('bg-cyan-600', 'bg-gray-700'));
                const activeBtn = document.getElementById(`nav-${targetPageId.substring(5)}`);
                if (activeBtn) activeBtn.classList.replace('bg-gray-700', 'bg-cyan-600');

                if (targetPageId === 'page-absensi') {
                    populateSessionSelector();
                } else if (targetPageId === 'page-registrasi') {
                    const container = document.querySelector('#page-registrasi .video-container');
                    startWebcam(container);
                } else if (targetPageId === 'page-peserta') {
                    displayPeserta();
                } else if (targetPageId === 'page-laporan') {
                    displayLaporan();
                } else if (targetPageId === 'page-sesi-list') {
                    displaySessionList();
                } else if (targetPageId === 'page-grafik') {
                    displayGrafik();
                }
            }
            
            function populateSessionSelector() {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const activeSessions = getSessions().filter(s => {
                    if (s.date !== todayStr) return false;
                    const startTime = new Date(`${s.date}T${s.startTime}`);
                    const endTime = new Date(`${s.date}T${s.endTime}`);
                    return now >= startTime && now <= endTime;
                });
                sessionSelector.innerHTML = '<option value="">-- Pilih Sesi Aktif --</option>';
                if (activeSessions.length > 0) {
                    activeSessions.forEach((s, index) => {
                        sessionSelector.innerHTML += `<option value="${s.id}">Sesi #${index + 1} (${s.startTime} - ${s.endTime})</option>`;
                    });
                } else {
                    sessionSelector.innerHTML = '<option value="">Tidak ada sesi aktif</option>';
                }
            }

            // --- Sisa Fungsi Display dan Event Listener ---
            createSessionBtn.addEventListener('click', () => {
                const date = sessionDateEl.value;
                const startTime = sessionStartTimeEl.value;
                const endTime = sessionEndTimeEl.value;
                const allParticipants = getRegisteredUsers().map(u => u.name);

                if (!date || !startTime || !endTime) {
                    return showSessionStatus('Semua kolom harus diisi.', 'error');
                }
                if (allParticipants.length === 0) {
                    return showSessionStatus('Belum ada peserta terdaftar.', 'error');
                }

                const sessions = getSessions();
                const newSession = {
                    id: `${date}-${sessions.length + 1}`,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    participants: allParticipants
                };
                sessions.push(newSession);
                saveSessions(sessions);
                showSessionStatus(`Sesi untuk tanggal ${date} berhasil dibuat.`, 'success');
                speak("Sesi berhasil dibuat");
            });

            function showSessionStatus(message, type) {
                sessionStatusEl.innerText = message;
                sessionStatusEl.className = 'text-center mt-4 p-3 rounded-lg min-h-[50px]';
                if (type === 'success') sessionStatusEl.classList.add('bg-green-900', 'text-green-300');
                else if (type === 'error') sessionStatusEl.classList.add('bg-red-900', 'text-red-300');
            }

            function displayPeserta() {
                const users = getRegisteredUsers();
                pesertaBody.innerHTML = '';
                if (users.length === 0) {
                    pesertaBody.innerHTML = `<tr><td colspan="2" class="text-center py-4">Belum ada peserta terdaftar.</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                    row.innerHTML = `<td class="py-4 px-6 font-medium text-white whitespace-nowrap">${user.name}</td><td class="py-4 px-6 text-right"><button data-name="${user.name}" class="delete-user-btn font-medium text-red-500 hover:underline">Hapus</button></td>`;
                    pesertaBody.appendChild(row);
                });
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteUser(e.target.getAttribute('data-name')));
                });
            }

            function deleteUser(name) {
                if (confirm(`Apakah Anda yakin ingin menghapus peserta "${name}"?`)) {
                    let users = getRegisteredUsers().filter(user => user.name !== name);
                    saveRegisteredUsers(users);
                    displayPeserta();
                    speak(`${name} telah dihapus.`);
                }
            }

            function displaySessionList() {
                sessionListContainer.innerHTML = '';
                const sessions = getSessions().sort((a,b) => new Date(b.date) - new Date(a.date));
                if (sessions.length === 0) {
                    sessionListContainer.innerHTML = '<p class="text-gray-400 text-center">Belum ada sesi yang dibuat.</p>';
                    return;
                }
                sessions.forEach(s => {
                    const sessionElement = document.createElement('div');
                    sessionElement.className = 'bg-gray-700 p-4 rounded-lg';
                    sessionElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="cursor-pointer flex-grow" data-session-id="${s.id}">
                                <h3 class="font-bold text-lg">${s.date}</h3>
                                <p class="text-sm text-gray-400">Jam: ${s.startTime} - ${s.endTime}</p>
                                <p class="text-sm text-gray-400">${s.participants.length} Peserta</p>
                            </div>
                            <button data-session-id="${s.id}" class="delete-session-btn text-red-500 hover:text-red-400 font-bold p-1 text-xl">&times;</button>
                        </div>
                        <div id="detail-${s.id}" class="hidden mt-3 pt-3 border-t border-gray-600"></div>
                    `;
                    sessionElement.querySelector('.cursor-pointer').addEventListener('click', () => {
                        const detailEl = document.getElementById(`detail-${s.id}`);
                        detailEl.classList.toggle('hidden');
                        if (!detailEl.classList.contains('hidden')) showSessionDetail(s.id, detailEl);
                    });
                    sessionElement.querySelector('.delete-session-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSession(s.id);
                    });
                    sessionListContainer.appendChild(sessionElement);
                });
            }

            function deleteSession(sessionId) {
                if (confirm('Yakin menghapus sesi ini dan semua data absensinya?')) {
                    saveSessions(getSessions().filter(s => s.id !== sessionId));
                    saveAttendanceLog(getAttendanceLog().filter(l => l.sessionId !== sessionId));
                    speak("Sesi telah dihapus.");
                    displaySessionList();
                }
            }

            function showSessionDetail(sessionId, detailElement) {
                const session = getSessions().find(s => s.id === sessionId);
                const sessionLog = getAttendanceLog().filter(l => l.sessionId === sessionId);
                const listHtml = session.participants.map(pName => {
                    const record = sessionLog.find(l => l.name === pName);
                    const status = record ? record.status : 'Tidak Hadir';
                    const color = record ? 'text-green-400' : 'text-red-400';
                    return `<li class="text-sm ${color}">${pName}: ${status}</li>`;
                }).join('');
                detailElement.innerHTML = `<ul class="space-y-1">${listHtml}</ul>`;
            }

            function displayGrafik() {
                populateGrafikSessionFilter();
                displayAttendanceSummaryChart();
                displayPerformanceRankingChart();
            }

            function populateGrafikSessionFilter() {
                const sessions = getSessions();
                grafikSessionFilter.innerHTML = '<option value="all">Semua Sesi</option>';
                sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                    grafikSessionFilter.innerHTML += `<option value="${s.id}">${s.date} @ ${s.startTime}</option>`;
                });
            }

            function displayAttendanceSummaryChart() {
                const sessionId = grafikSessionFilter.value;
                const ctx = document.getElementById('summaryChart').getContext('2d');
                if (summaryChart) summaryChart.destroy();

                const sessions = getSessions();
                const log = getAttendanceLog();
                const relevantSessions = sessionId === 'all' ? sessions : sessions.filter(s => s.id === sessionId);
                if (relevantSessions.length === 0) return;

                let statusCounts = { 'Hadir': 0, 'Izin': 0, 'Sakit': 0, 'Tidak Hadir': 0 };
                relevantSessions.forEach(session => {
                    session.participants.forEach(pName => {
                        const record = log.find(l => l.sessionId === session.id && l.name === pName);
                        statusCounts[record ? record.status : 'Tidak Hadir']++;
                    });
                });

                summaryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Hadir', 'Tidak Hadir', 'Izin', 'Sakit'],
                        datasets: [{
                            data: [statusCounts.Hadir, statusCounts['Tidak Hadir'], statusCounts.Izin, statusCounts.Sakit],
                            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6', '#f59e0b'],
                            borderColor: '#4b5563',
                        }]
                    },
                    options: { plugins: { legend: { labels: { color: '#e5e7eb' } } } }
                });
            }

            function displayPerformanceRankingChart() {
                const log = getAttendanceLog();
                const userScores = getRegisteredUsers().map(user => ({
                    name: user.name,
                    score: log.filter(l => l.name === user.name && l.remark === 'Tepat Waktu').length
                })).sort((a, b) => b.score - a.score);

                performanceLeaderboardContainer.innerHTML = userScores.map((user, index) => {
                    const rank = index + 1;
                    const colors = { 1: 'text-yellow-300', 2: 'text-gray-200', 3: 'text-orange-300' };
                    const icon = { 1: 'üèÜ', 2: 'ü•à', 3: 'ü•â' };
                    return `<div class="p-3 rounded-lg bg-gray-800/50 flex items-center justify-between">
                                <div class="flex items-center">
                                    <p class="font-bold text-lg mr-4 ${colors[rank] || 'text-gray-400'}">${icon[rank] || `#${rank}`}</p>
                                    <p>${user.name}</p>
                                </div>
                                <p class="font-semibold text-gray-300">${user.score} Poin</p>
                            </div>`;
                }).join('');
            }

            grafikSessionFilter.addEventListener('change', () => {
                displayAttendanceSummaryChart();
            });

            function displayLaporan() {
                const sessions = getSessions();
                reportSessionFilter.innerHTML = '<option value="">-- Pilih Sesi --</option>';
                sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                    reportSessionFilter.innerHTML += `<option value="${s.id}">${s.date} @ ${s.startTime}</option>`;
                });
                renderLaporanTable();
            }

            function renderLaporanTable() {
                const sessionId = reportSessionFilter.value;
                if (!sessionId) {
                    laporanBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Pilih sesi.</td></tr>`;
                    return;
                }
                const session = getSessions().find(s => s.id === sessionId);
                const log = getAttendanceLog();
                laporanBody.innerHTML = session.participants.map(pName => {
                    const record = log.find(l => l.name === pName && l.sessionId === sessionId);
                    const status = record ? record.status : 'Tidak Hadir';
                    const time = record && record.time ? record.time : '-';
                    const remark = record && record.remark ? record.remark : '-';
                    return `
                        <tr class="bg-gray-800 border-b border-gray-700">
                            <td class="py-4 px-6">${pName}</td>
                            <td class="py-4 px-6">${status}</td>
                            <td class="py-4 px-6">${time}</td>
                            <td class="py-4 px-6">${remark}</td>
                            <td class="py-4 px-6 text-right no-print">
                                <button data-name="${pName}" data-session-id="${sessionId}" class="delete-log-btn font-medium text-red-500 hover:underline">Hapus</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            reportSessionFilter.addEventListener('change', renderLaporanTable);

            laporanBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-log-btn')) {
                    const { name, sessionId } = e.target.dataset;
                    if (confirm(`Yakin hapus absensi ${name}?`)) {
                        saveAttendanceLog(getAttendanceLog().filter(l => !(l.name === name && l.sessionId === sessionId)));
                        renderLaporanTable();
                    }
                }
            });

            printLaporanBtn.addEventListener('click', () => {
                if (!reportSessionFilter.value) return alert("Pilih sesi.");
                window.print();
            });

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = `page-${btn.id.substring(4)}`;
                    switchPage(pageId);
                });
            });

            initialize();
        });
    </script>
</body>
</html>
