<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Face ID</title>
    
    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" id="manifest">
    <meta name="theme-color" content="#1f2937"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1f2937/ffffff?text=Absen">

    <!-- Menggunakan Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mengimpor library face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Custom style untuk posisi video dan canvas */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4 / 3;
            margin: 0 auto;
            background-color: #333;
            border-radius: 0.5rem;
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
        #video {
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-gray-800 rounded-lg shadow-xl p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-cyan-400">Sistem Absensi Pengenalan Wajah</h1>
            <p class="text-gray-400">Daftarkan wajah, lalu lakukan absensi sekali sehari.</p>
        </header>

        <!-- Navigasi -->
        <nav class="flex justify-center space-x-2 sm:space-x-4 mb-6 border-b border-gray-700 pb-4">
            <button id="nav-absensi" class="nav-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Absensi</button>
            <button id="nav-registrasi" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Registrasi</button>
            <button id="nav-peserta" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Daftar Peserta</button>
            <button id="nav-laporan" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Laporan</button>
        </nav>

        <main>
            <!-- Halaman Absensi -->
            <div id="page-absensi" class="page">
                <div class="video-container mb-4">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
                <div id="status-container" class="text-center p-4 rounded-lg bg-gray-700 min-h-[80px] flex items-center justify-center mb-4">
                    <p id="status" class="text-lg">Menginisialisasi kamera dan model...</p>
                </div>
                <div class="flex justify-center space-x-4">
                    <button id="absen-btn" class="action-btn bg-green-600 hover:bg-green-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-300">Lakukan Absen</button>
                </div>
            </div>

            <!-- Halaman Registrasi -->
            <div id="page-registrasi" class="page hidden">
                 <div class="video-container mb-4">
                    <!-- Placeholder untuk video, akan dipindahkan oleh JS -->
                </div>
                <div class="max-w-md mx-auto">
                    <div class="mb-6">
                        <label for="namaLengkap" class="block mb-2 text-sm font-medium text-gray-300">Nama Lengkap</label>
                        <input type="text" id="namaLengkap" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5" placeholder="Contoh: Budi Sanjaya" required>
                    </div>
                    <button id="register-btn" class="w-full action-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Daftarkan Wajah</button>
                </div>
                 <div id="register-status" class="text-center mt-4 p-3 rounded-lg min-h-[50px]"></div>
            </div>

            <!-- Halaman Daftar Peserta -->
            <div id="page-peserta" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Daftar Peserta Terdaftar</h2>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nama</th>
                                <th scope="col" class="py-3 px-6 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="peserta-body">
                           <!-- Data peserta akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Halaman Laporan -->
            <div id="page-laporan" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Laporan Absensi</h2>
                <div class="flex justify-end mb-4">
                    <button id="clear-laporan" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg text-sm">Bersihkan Laporan</button>
                </div>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nama</th>
                                <th scope="col" class="py-3 px-6">Waktu Absen</th>
                                <th scope="col" class="py-3 px-6">Tanggal</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-body">
                           <!-- Data laporan akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elemen DOM ---
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const context = overlay.getContext('2d');
            const statusEl = document.getElementById('status');
            const registerStatusEl = document.getElementById('register-status');
            const absenBtn = document.getElementById('absen-btn');
            const registerBtn = document.getElementById('register-btn');
            const actionBtns = document.querySelectorAll('.action-btn');

            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            const laporanBody = document.getElementById('laporan-body');
            const pesertaBody = document.getElementById('peserta-body');
            const clearLaporanBtn = document.getElementById('clear-laporan');

            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            let detectionInterval;
            let lastMatches = [];

            // --- Fungsi Notifikasi Suara ---
            function speak(text) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                window.speechSynthesis.speak(utterance);
            }

            // --- Setup PWA (Progressive Web App) ---
            function setupPWA() {
                const manifestData = {
                    "name": "Aplikasi Absensi Wajah", "short_name": "Absen Wajah", "start_url": ".", "display": "standalone",
                    "background_color": "#1f2937", "theme_color": "#1f2937", "description": "Aplikasi untuk melakukan absensi menggunakan pengenalan wajah.",
                    "icons": [
                        { "src": "https://placehold.co/192x192/1f2937/ffffff?text=Absen", "type": "image/png", "sizes": "192x192" },
                        { "src": "https://placehold.co/512x512/1f2937/ffffff?text=Absen", "type": "image/png", "sizes": "512x512" }
                    ]
                };
                const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifest').setAttribute('href', manifestURL);
                if ('serviceWorker' in navigator) {
                    console.log('Service Worker didukung, tetapi registrasi dari blob URL dinonaktifkan untuk menghindari error.');
                }
            }

            // --- Inisialisasi Aplikasi ---
            async function initialize() {
                try {
                    statusEl.innerText = 'Memuat model pengenalan wajah...';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                    ]);
                    startWebcam();
                } catch (error) {
                    console.error("Gagal memuat model:", error);
                    statusEl.innerText = 'Error: Gagal memuat model. Cek koneksi internet.';
                    statusEl.classList.add('text-red-500');
                }
            }

            // --- Fungsi Webcam & Deteksi Wajah ---
            async function startWebcam() {
                try {
                    statusEl.innerText = 'Menyalakan kamera...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    video.srcObject = stream;
                } catch (error) {
                    console.error("Gagal mengakses webcam:", error);
                    statusEl.innerText = 'Error: Gagal mengakses kamera. Izinkan akses kamera di browser Anda.';
                    statusEl.classList.add('text-red-500');
                }
            }

            video.addEventListener('play', () => {
                statusEl.innerText = 'Kamera aktif. Arahkan wajah Anda ke kamera.';
                actionBtns.forEach(btn => btn.disabled = false);
                
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(overlay, displaySize);

                detectionInterval = setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    
                    context.clearRect(0, 0, overlay.width, overlay.height);

                    if (lastMatches.length > 0) {
                        lastMatches.forEach(match => {
                            const resizedResult = faceapi.resizeResults(match, displaySize);
                            let boxColor;
                            switch(match.status) {
                                case 'success': boxColor = '#22c55e'; break; // hijau
                                case 'error':   boxColor = '#ef4444'; break;   // merah
                                case 'info':    boxColor = '#3b82f6'; break;    // biru
                                default:        boxColor = '#6b7280';          // abu-abu
                            }
                            const drawBox = new faceapi.draw.DrawBox(resizedResult.detection.box, { 
                                label: match.label, boxColor: boxColor,
                                drawLabelOptions: { fontColor: 'white', backgroundColor: boxColor }
                            });
                            drawBox.draw(overlay);
                        });
                    } else {
                        faceapi.draw.drawDetections(overlay, resizedDetections);
                        if (detections.length > 0) {
                           if (!statusEl.innerText.includes('Mendeteksi')) {
                                statusEl.innerText = `${detections.length} wajah terdeteksi. Siap untuk absensi.`;
                           }
                        } else {
                            statusEl.innerText = 'Tidak ada wajah terdeteksi. Arahkan wajah ke kamera.';
                        }
                    }
                }, 200);
            });

            // --- Manajemen Data (localStorage) ---
            function getRegisteredUsers() { return JSON.parse(localStorage.getItem('faceAttendanceUsers')) || []; }
            function saveRegisteredUsers(users) { localStorage.setItem('faceAttendanceUsers', JSON.stringify(users)); }
            function getAttendanceLog() { return JSON.parse(localStorage.getItem('faceAttendanceLog')) || []; }
            function saveAttendanceLog(log) { localStorage.setItem('faceAttendanceLog', JSON.stringify(log)); }

            // --- Fungsi Registrasi ---
            registerBtn.addEventListener('click', async () => {
                const namaLengkap = document.getElementById('namaLengkap').value.trim();
                if (!namaLengkap) {
                    showRegisterStatus('Nama Lengkap wajib diisi.', 'error');
                    return;
                }
                showRegisterStatus('Memproses... Deteksi wajah...', 'info');
                const detections = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
                if (!detections) {
                    showRegisterStatus('Wajah tidak terdeteksi. Pastikan wajah terlihat jelas.', 'error');
                    return;
                }
                const users = getRegisteredUsers();
                if (users.some(user => user.name.toLowerCase() === namaLengkap.toLowerCase())) {
                    showRegisterStatus(`Nama "${namaLengkap}" sudah terdaftar.`, 'error');
                    return;
                }
                users.push({ name: namaLengkap, descriptor: Array.from(detections.descriptor) });
                saveRegisteredUsers(users);
                showRegisterStatus(`Registrasi berhasil untuk ${namaLengkap}!`, 'success');
                speak(`Registrasi berhasil untuk ${namaLengkap}`);
                document.getElementById('namaLengkap').value = '';
            });
            
            function showRegisterStatus(message, type) {
                registerStatusEl.innerText = message;
                registerStatusEl.className = 'text-center mt-4 p-3 rounded-lg min-h-[50px]';
                if (type === 'success') registerStatusEl.classList.add('bg-green-900', 'text-green-300');
                else if (type === 'error') registerStatusEl.classList.add('bg-red-900', 'text-red-300');
                else registerStatusEl.classList.add('bg-blue-900', 'text-blue-300');
            }

            // --- Fungsi Absensi (Multi-Wajah) ---
            absenBtn.addEventListener('click', async () => {
                const users = getRegisteredUsers();
                if (users.length === 0) {
                    statusEl.innerText = 'Belum ada pengguna terdaftar.';
                    return;
                }
                statusEl.innerText = 'Mendeteksi semua wajah untuk absensi...';
                const labeledFaceDescriptors = users.map(user => new faceapi.LabeledFaceDescriptors(user.name, [new Float32Array(user.descriptor)]));
                
                // **FIX:** Mengubah ambang batas dari 0.5 ke 0.6 untuk pencocokan yang lebih longgar
                const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6); 
                
                const allResults = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                
                if (allResults.length > 0) {
                    const matches = [];
                    const successfulNames = [];
                    const alreadyAttendedNames = [];

                    allResults.forEach(result => {
                        const bestMatch = faceMatcher.findBestMatch(result.descriptor);
                        const user = users.find(u => u.name === bestMatch.label);
                        if (user) {
                            const attendanceStatus = recordAttendance(user);
                            if (attendanceStatus === 'success') {
                                matches.push({ detection: result.detection, label: user.name, status: 'success' });
                                successfulNames.push(user.name);
                            } else if (attendanceStatus === 'already_attended') {
                                matches.push({ detection: result.detection, label: `${user.name} (Sudah Absen)`, status: 'info' });
                                alreadyAttendedNames.push(user.name);
                            }
                        } else {
                            matches.push({ detection: result.detection, label: 'Tidak Dikenali', status: 'error' });
                        }
                    });

                    lastMatches = matches;
                    
                    let summaryParts = [];
                    if (successfulNames.length > 0) {
                        summaryParts.push(`Absensi berhasil untuk: ${successfulNames.join(', ')}.`);
                    }
                    if (alreadyAttendedNames.length > 0) {
                        summaryParts.push(`${alreadyAttendedNames.join(', ')} sudah absen sebelumnya.`);
                    }

                    if (summaryParts.length > 0) {
                        statusEl.innerText = summaryParts.join(' ');
                        if (successfulNames.length > 0) {
                            speak(`${successfulNames.length} orang berhasil diabsen.`);
                        }
                    } else {
                        statusEl.innerText = 'Tidak ada wajah yang dikenali atau semua sudah absen.';
                        speak('Tidak ada wajah yang dikenali.');
                    }

                } else {
                    lastMatches = [];
                    statusEl.innerText = 'Tidak ada wajah terdeteksi.';
                    speak('Tidak ada wajah terdeteksi.');
                }
                setTimeout(() => { lastMatches = []; }, 4000);
            });

            function recordAttendance(user) {
                const log = getAttendanceLog();
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const hasAttendedToday = log.some(entry => entry.name === user.name && entry.date === today);

                if (hasAttendedToday) {
                    return 'already_attended';
                }
                log.push({ name: user.name, date: today, time: now.toLocaleTimeString('id-ID') });
                saveAttendanceLog(log);
                return 'success';
            }

            // --- Fungsi Daftar Peserta ---
            function displayPeserta() {
                const users = getRegisteredUsers();
                pesertaBody.innerHTML = '';
                if (users.length === 0) {
                    pesertaBody.innerHTML = `<tr><td colspan="2" class="text-center py-4">Belum ada peserta terdaftar.</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                    row.innerHTML = `<td class="py-4 px-6 font-medium text-white whitespace-nowrap">${user.name}</td><td class="py-4 px-6 text-right"><button data-name="${user.name}" class="delete-user-btn font-medium text-red-500 hover:underline">Hapus</button></td>`;
                    pesertaBody.appendChild(row);
                });
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteUser(e.target.getAttribute('data-name')));
                });
            }

            function deleteUser(name) {
                if (confirm(`Apakah Anda yakin ingin menghapus peserta "${name}"?`)) {
                    let users = getRegisteredUsers().filter(user => user.name !== name);
                    saveRegisteredUsers(users);
                    displayPeserta();
                    speak(`${name} telah dihapus.`);
                }
            }

            // --- Fungsi Laporan ---
            function displayLaporan() {
                const log = getAttendanceLog();
                laporanBody.innerHTML = '';
                if (log.length === 0) {
                    laporanBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">Belum ada data absensi.</td></tr>`;
                    return;
                }
                log.sort((a,b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
                log.forEach(entry => {
                    laporanBody.innerHTML += `<tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-600"><td class="py-4 px-6 font-medium text-white whitespace-nowrap">${entry.name}</td><td class="py-4 px-6">${entry.time}</td><td class="py-4 px-6">${new Date(entry.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td></tr>`;
                });
            }

            clearLaporanBtn.addEventListener('click', () => {
                if (confirm('Yakin ingin menghapus semua data laporan?')) {
                    localStorage.removeItem('faceAttendanceLog');
                    displayLaporan();
                    speak("Semua laporan telah dibersihkan.");
                }
            });

            // --- Navigasi Halaman ---
            function switchPage(targetPageId) {
                pages.forEach(page => page.classList.add('hidden'));
                document.getElementById(targetPageId).classList.remove('hidden');
                navButtons.forEach(btn => btn.classList.replace('bg-cyan-600', 'bg-gray-700'));
                const activeBtn = document.getElementById(`nav-${targetPageId.split('-')[1]}`);
                if(activeBtn) activeBtn.classList.replace('bg-gray-700', 'bg-cyan-600');
                if (targetPageId === 'page-absensi' || targetPageId === 'page-registrasi') {
                    const targetContainer = document.querySelector(`#${targetPageId} .video-container`);
                    if (targetContainer) {
                         targetContainer.appendChild(video);
                         targetContainer.appendChild(overlay);
                    }
                }
                if (targetPageId === 'page-laporan') displayLaporan();
                if (targetPageId === 'page-peserta') displayPeserta();
            }

            document.getElementById('nav-absensi').addEventListener('click', () => switchPage('page-absensi'));
            document.getElementById('nav-registrasi').addEventListener('click', () => switchPage('page-registrasi'));
            document.getElementById('nav-peserta').addEventListener('click', () => switchPage('page-peserta'));
            document.getElementById('nav-laporan').addEventListener('click', () => switchPage('page-laporan'));

            // --- Mulai Aplikasi ---
            setupPWA();
            initialize();
        });
    </script>
</body>
</html>
