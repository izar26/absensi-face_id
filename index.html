<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Face ID (Diperbaiki)</title>
    
    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" id="manifest">
    <meta name="theme-color" content="#1f2937"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1f2937/ffffff?text=Absen">

    <!-- Menggunakan Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mengimpor library face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Mengimpor Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom style untuk posisi video dan canvas */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4 / 3;
            margin: 0 auto;
            background-color: #333;
            border-radius: 0.5rem;
            overflow: hidden; /* Menjaga elemen di dalam container */
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
        #video {
            object-fit: cover;
            transform: scaleX(-1); /* Cermin untuk kamera depan */
        }
        #camera-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
        }
        /* Style untuk Print */
        @media print {
            body > *:not(.printable-area) {
                display: none;
            }
            .printable-area, .printable-area #page-laporan {
                display: block !important;
                visibility: visible;
            }
            .no-print {
                display: none !important;
            }
            body, .bg-gray-800 {
                background-color: white !important;
                color: black !important;
            }
            h2, th, td {
                color: black !important;
            }
            thead {
                background-color: #eee !important;
            }
            tr {
                border-bottom: 1px solid #ccc;
            }
            #laporan-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            .status-override-select {
                display: none;
            }
            .status-print-only {
                display: inline !important;
            }
        }
        .status-print-only {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-gray-800 rounded-lg shadow-xl p-6 printable-area">
        <header class="text-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-cyan-400">Sistem Absensi Pengenalan Wajah</h1>
            <p class="text-gray-400">Akurasi ditingkatkan dengan registrasi multi-sampel dan deteksi stabil.</p>
        </header>

        <!-- Navigasi -->
        <nav class="flex justify-center flex-wrap gap-2 sm:space-x-4 mb-6 border-b border-gray-700 pb-4 no-print">
            <button id="nav-absensi" class="nav-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Absensi</button>
            <button id="nav-registrasi" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Registrasi</button>
            <button id="nav-peserta" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Daftar Peserta</button>
            <button id="nav-jadwal" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Buat Sesi</button>
            <button id="nav-sesi-list" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Daftar Sesi</button>
            <button id="nav-laporan" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Laporan</button>
            <button id="nav-grafik" class="nav-btn bg-gray-700 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm sm:text-base">Grafik</button>
        </nav>

        <main>
            <!-- Halaman Absensi -->
            <div id="page-absensi" class="page">
                 <div class="mb-4">
                    <label for="session-selector" class="block mb-2 text-sm font-medium text-gray-300">Pilih Sesi Aktif Hari Ini:</label>
                    <select id="session-selector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5"></select>
                </div>
                <div class="video-container mb-4">
                    <div id="camera-placeholder-absensi"><p>Pilih sesi untuk mengaktifkan kamera</p></div>
                </div>
                <div id="status-container" class="text-center p-4 rounded-lg bg-gray-700 min-h-[80px] flex items-center justify-center mb-4">
                    <p id="status" class="text-lg">Menginisialisasi model...</p>
                </div>
                <p class="text-xs text-gray-500 text-center mt-2">Tips: Pastikan wajah Anda berada di area dengan pencahayaan yang baik.</p>
            </div>

            <!-- Halaman Registrasi -->
            <div id="page-registrasi" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Registrasi Wajah Baru</h2>
                <div class="video-container mb-4">
                     <div id="camera-placeholder-registrasi"><p>Kamera akan aktif di sini</p></div>
                </div>
                 <div class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label for="namaLengkap" class="block mb-2 text-sm font-medium text-gray-300">Nama Lengkap</label>
                        <input type="text" id="namaLengkap" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5" placeholder="Contoh: Budi Sanjaya" required>
                    </div>
                    <button id="register-btn" class="w-full action-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition duration-300">Mulai Registrasi</button>
                    <div id="register-status" class="text-center mt-4 p-3 rounded-lg min-h-[50px]"></div>
                </div>
            </div>

            <!-- Halaman Jadwal Sesi -->
            <div id="page-jadwal" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Buat Jadwal Sesi Baru</h2>
                <div class="max-w-md mx-auto">
                    <div class="mb-4">
                        <label for="session-date" class="block mb-2 text-sm font-medium text-gray-300">Tanggal Sesi</label>
                        <input type="date" id="session-date" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="session-start-time" class="block mb-2 text-sm font-medium text-gray-300">Jam Mulai</label>
                            <input type="time" id="session-start-time" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="session-end-time" class="block mb-2 text-sm font-medium text-gray-300">Jam Selesai</label>
                            <input type="time" id="session-end-time" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mb-4">Semua peserta yang terdaftar akan otomatis dimasukkan ke dalam sesi ini.</p>
                    <button id="create-session-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Buat Sesi</button>
                    <div id="session-status" class="text-center mt-4 p-3 rounded-lg min-h-[50px]"></div>
                </div>
            </div>

            <!-- Halaman Daftar Sesi -->
            <div id="page-sesi-list" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Daftar Semua Sesi</h2>
                <div id="session-list-container" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Daftar sesi akan di-generate oleh JS -->
                </div>
            </div>

             <!-- Halaman Grafik -->
            <div id="page-grafik" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Analisis Kehadiran</h2>
                <div class="mb-6">
                    <label for="grafik-session-filter" class="block mb-2 text-sm font-medium text-gray-300">Pilih Sesi untuk Ringkasan:</label>
                    <select id="grafik-session-filter" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5"></select>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg mb-6">
                    <canvas id="summaryChart"></canvas>
                </div>
                <h3 class="text-xl font-semibold text-center mb-4 text-cyan-400">Peringkat Disiplin (Total Poin Tepat Waktu)</h3>
                <div id="performance-leaderboard-container" class="space-y-2">
                    <!-- Peringkat akan di-generate oleh JS -->
                </div>
            </div>

            <!-- Halaman Daftar Peserta -->
            <div id="page-peserta" class="page hidden">
                <h2 class="text-2xl font-semibold text-center mb-4 text-cyan-400">Daftar Peserta Terdaftar</h2>
                <div class="overflow-x-auto relative shadow-md sm:rounded-lg max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nama</th>
                                <th scope="col" class="py-3 px-6 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="peserta-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Halaman Laporan -->
            <div id="page-laporan" class="page hidden">
                <h2 id="laporan-title" class="text-2xl font-semibold text-center mb-4 text-cyan-400">Laporan Kehadiran</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 no-print">
                    <div class="w-full sm:w-auto">
                        <label for="report-session-filter" class="sr-only">Filter Sesi:</label>
                        <select id="report-session-filter" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5"></select>
                    </div>
                    <div class="flex space-x-2">
                        <button id="print-laporan" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Print Laporan</button>
                    </div>
                </div>
                <div id="laporan-container" class="overflow-x-auto relative shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Nama</th>
                                <th scope="col" class="py-3 px-6">Status</th>
                                <th scope="col" class="py-3 px-6">Waktu Absen</th>
                                <th scope="col" class="py-3 px-6">Keterangan</th>
                                <th scope="col" class="py-3 px-6 text-right no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Video elements moved here to be globally accessible and not re-created -->
    <div id="global-video-container" style="display: none;">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <button id="switch-camera-btn" class="absolute top-2 right-2 bg-gray-800 bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 z-10 hidden" title="Ganti Kamera">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20L20 4M20 4v5h-5M4 4h5v5"></path></svg>
        </button>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elemen DOM ---
            const video = document.getElementById('video');
            const overlay = document.getElementById('overlay');
            const context = overlay.getContext('2d');
            const statusEl = document.getElementById('status');
            const registerStatusEl = document.getElementById('register-status');
            const registerBtn = document.getElementById('register-btn');

            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            const laporanBody = document.getElementById('laporan-body');
            const pesertaBody = document.getElementById('peserta-body');
            
            const sessionDateEl = document.getElementById('session-date');
            const sessionStartTimeEl = document.getElementById('session-start-time');
            const sessionEndTimeEl = document.getElementById('session-end-time');
            const createSessionBtn = document.getElementById('create-session-btn');
            const sessionStatusEl = document.getElementById('session-status');
            const sessionSelector = document.getElementById('session-selector');
            const reportSessionFilter = document.getElementById('report-session-filter');
            const printLaporanBtn = document.getElementById('print-laporan');
            const sessionListContainer = document.getElementById('session-list-container');
            const switchCameraBtn = document.getElementById('switch-camera-btn');
            const grafikSessionFilter = document.getElementById('grafik-session-filter');
            const performanceLeaderboardContainer = document.getElementById('performance-leaderboard-container');
            let summaryChart = null;

            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            let currentStream = null;
            let facingMode = 'user';
            let attendedThisSession = [];
            let detectionInterval; // Ganti loop dengan interval

            // --- PERBAIKAN: Variabel State untuk Logika Baru ---
            let isRegistrationMode = false;
            let registrationSamples = [];
            const SAMPLES_REQUIRED = 3;
            let attendanceTracker = { name: null, count: 0 };
            const ATTENDANCE_CONFIRMATION_FRAMES = 60; // ~2 detik pada 30fps

            // --- Fungsi Notifikasi Suara ---
            function speak(text) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                window.speechSynthesis.speak(utterance);
            }

            // --- Setup PWA (Progressive Web App) ---
            function setupPWA() {
                const manifestData = {
                    "name": "Aplikasi Absensi Wajah", "short_name": "Absen Wajah", "start_url": ".", "display": "standalone",
                    "background_color": "#1f2937", "theme_color": "#1f2937", "description": "Aplikasi untuk melakukan absensi menggunakan pengenalan wajah.",
                    "icons": [
                        { "src": "https://placehold.co/192x192/1f2937/ffffff?text=Absen", "type": "image/png", "sizes": "192x192" },
                        { "src": "https://placehold.co/512x512/1f2937/ffffff?text=Absen", "type": "image/png", "sizes": "512x512" }
                    ]
                };
                const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                document.querySelector('#manifest').setAttribute('href', manifestURL);
            }

            // --- Inisialisasi Aplikasi ---
            async function initialize() {
                try {
                    statusEl.innerText = 'Memuat model pengenalan wajah...';
                    await Promise.all([
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL), // PERBAIKAN: Ganti ke model yang lebih akurat
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    checkCameraSupport();
                    switchPage('page-absensi');
                } catch (error) {
                    console.error("Gagal memuat model:", error);
                    statusEl.innerText = 'Error: Gagal memuat model. Cek koneksi internet.';
                    statusEl.classList.add('text-red-500');
                }
            }

            // --- Fungsi Webcam & Deteksi Wajah ---
            function stopWebcam() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
                // Sembunyikan video dan overlay dari container manapun
                const videoContainer = video.parentElement;
                if (videoContainer) {
                    const placeholderId = videoContainer.id.replace('video-container', 'camera-placeholder');
                    const placeholder = document.getElementById(placeholderId);
                    if(placeholder) placeholder.classList.remove('hidden');
                }
                video.classList.add('hidden');
                overlay.classList.add('hidden');
                statusEl.innerText = 'Kamera tidak aktif.';
            }

            async function startWebcam(containerElement) {
                if (currentStream || !containerElement) return;
                try {
                    statusEl.innerText = 'Menyalakan kamera...';
                    
                    // Pindahkan elemen video ke container yang tepat
                    containerElement.append(video, overlay, switchCameraBtn);
                    video.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    const placeholder = containerElement.querySelector('[id^="camera-placeholder"]');
                    if(placeholder) placeholder.innerHTML = '';
                    
                    const constraints = { video: { facingMode: facingMode, width: { ideal: 640 }, height: { ideal: 480 } } };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    currentStream = stream;

                    video.onloadedmetadata = () => {
                        const displaySize = { width: containerElement.clientWidth, height: containerElement.clientHeight };
                        faceapi.matchDimensions(overlay, displaySize);
                        if (!detectionInterval) {
                            detectionInterval = setInterval(detectFaces, 100); // Deteksi setiap 100ms
                        }
                    };
                } catch (error) {
                    console.error("Gagal mengakses webcam:", error);
                    statusEl.innerText = 'Error: Gagal mengakses kamera. Izinkan akses kamera di browser Anda.';
                    statusEl.classList.add('text-red-500');
                }
            }
            
            async function detectFaces() {
                if (video.paused || video.ended || !currentStream) return;

                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(overlay, displaySize);

                // PERBAIKAN: Gunakan model SsdMobilenetv1 yang lebih akurat
                const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                context.clearRect(0, 0, overlay.width, overlay.height);
                faceapi.draw.drawDetections(overlay, resizedDetections);
                
                const activePageId = document.querySelector('.page:not(.hidden)').id;
                const currentStatusEl = activePageId === 'page-registrasi' ? registerStatusEl : statusEl;
                
                if (detections.length !== 1) {
                    currentStatusEl.innerText = detections.length > 1 ? 'Hanya boleh ada satu wajah.' : 'Arahkan wajah ke kamera.';
                    if (activePageId === 'page-absensi') attendanceTracker = { name: null, count: 0 }; // Reset tracker
                    return;
                }

                const singleDetection = detections[0];
                
                if (isRegistrationMode) {
                    handleRegistrationProcess(singleDetection, currentStatusEl);
                } else if (activePageId === 'page-absensi') {
                    handleAutoAttendance(singleDetection, currentStatusEl);
                } else {
                     currentStatusEl.innerText = 'Wajah terdeteksi.';
                }
            }

            async function checkCameraSupport() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoInputs = devices.filter(device => device.kind === 'videoinput');
                    if (videoInputs.length > 1) {
                        switchCameraBtn.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error enumerating devices:", error);
                }
            }

            switchCameraBtn.addEventListener('click', () => {
                stopWebcam();
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                video.style.transform = facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
                const activePageId = document.querySelector('.page:not(.hidden)').id;
                const container = document.querySelector(`#${activePageId} .video-container`);
                if(container) startWebcam(container);
            });

            // --- Manajemen Data (localStorage) ---
            function getRegisteredUsers() { return JSON.parse(localStorage.getItem('faceAttendanceUsers_v2')) || []; }
            function saveRegisteredUsers(users) { localStorage.setItem('faceAttendanceUsers_v2', JSON.stringify(users)); }
            function getAttendanceLog() { return JSON.parse(localStorage.getItem('faceAttendanceLog')) || []; }
            function saveAttendanceLog(log) { localStorage.setItem('faceAttendanceLog', JSON.stringify(log)); }
            function getSessions() { return JSON.parse(localStorage.getItem('faceAttendanceSessions')) || []; }
            function saveSessions(sessions) { localStorage.setItem('faceAttendanceSessions', JSON.stringify(sessions)); }

            // --- PERBAIKAN: Fungsi Registrasi Multi-Sampel ---
            registerBtn.addEventListener('click', () => {
                const namaLengkap = document.getElementById('namaLengkap').value.trim();
                if (!namaLengkap) {
                    showRegisterStatus('Nama lengkap harus diisi.', 'error');
                    return;
                }
                const users = getRegisteredUsers();
                if (users.some(user => user.name.toLowerCase() === namaLengkap.toLowerCase())) {
                    showRegisterStatus(`Nama "${namaLengkap}" sudah terdaftar.`, 'error');
                    return;
                }
                
                isRegistrationMode = true;
                registrationSamples = [];
                registerBtn.disabled = true;
                registerBtn.innerText = 'Mengambil Sampel...';
            });

            async function handleRegistrationProcess(detection, statusUI) {
                const sampleCount = registrationSamples.length;
                statusUI.innerText = `Mengambil sampel ${sampleCount + 1} dari ${SAMPLES_REQUIRED}... Tahan posisi!`;

                // Beri jeda antar pengambilan sampel
                if (!window.takingSample) {
                    window.takingSample = true;
                    setTimeout(async () => {
                        registrationSamples.push(Array.from(detection.descriptor));
                        speak(`Sampel ${sampleCount + 1} diambil`);

                        if (registrationSamples.length >= SAMPLES_REQUIRED) {
                            await finalizeRegistration();
                        }
                        window.takingSample = false;
                    }, 1500); // Jeda 1.5 detik
                }
            }

            async function finalizeRegistration() {
                const namaLengkap = document.getElementById('namaLengkap').value.trim();
                const users = getRegisteredUsers();
                users.push({ name: namaLengkap, descriptors: registrationSamples });
                saveRegisteredUsers(users);
                
                showRegisterStatus(`Registrasi berhasil untuk ${namaLengkap}!`, 'success');
                speak(`Registrasi berhasil untuk ${namaLengkap}`);
                
                // Reset state
                document.getElementById('namaLengkap').value = '';
                isRegistrationMode = false;
                registrationSamples = [];
                registerBtn.disabled = false;
                registerBtn.innerText = 'Mulai Registrasi';
            }
            
            function showRegisterStatus(message, type) {
                registerStatusEl.innerText = message;
                registerStatusEl.className = 'text-center mt-4 p-3 rounded-lg min-h-[50px]';
                if (type === 'success') registerStatusEl.classList.add('bg-green-900', 'text-green-300');
                else if (type === 'error') registerStatusEl.classList.add('bg-red-900', 'text-red-300');
            }

            // --- Fungsi Jadwal Sesi ---
            createSessionBtn.addEventListener('click', () => {
                const date = sessionDateEl.value;
                const startTime = sessionStartTimeEl.value;
                const endTime = sessionEndTimeEl.value;
                const allParticipants = getRegisteredUsers().map(u => u.name);

                if (!date || !startTime || !endTime) {
                    showSessionStatus('Semua kolom harus diisi.', 'error');
                    return;
                }
                if (allParticipants.length === 0) {
                    showSessionStatus('Tidak bisa membuat sesi. Belum ada peserta yang terdaftar.', 'error');
                    return;
                }

                const sessions = getSessions();
                const newSession = {
                    id: `${date}-${sessions.length + 1}`,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    participants: allParticipants
                };
                sessions.push(newSession);
                saveSessions(sessions);
                showSessionStatus(`Sesi untuk tanggal ${date} berhasil dibuat.`, 'success');
                speak("Sesi berhasil dibuat");
            });

            function showSessionStatus(message, type) {
                sessionStatusEl.innerText = message;
                sessionStatusEl.className = 'text-center mt-4 p-3 rounded-lg min-h-[50px]';
                if (type === 'success') sessionStatusEl.classList.add('bg-green-900', 'text-green-300');
                else if (type === 'error') sessionStatusEl.classList.add('bg-red-900', 'text-red-300');
            }

            // --- PERBAIKAN: Fungsi Absensi Stabil ---
            function populateSessionSelector() {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                
                const activeSessions = getSessions().filter(s => {
                    if (s.date !== todayStr) return false;
                    const startTime = new Date(`${s.date}T${s.startTime}`);
                    const endTime = new Date(`${s.date}T${s.endTime}`);
                    return now >= startTime && now <= endTime;
                });

                sessionSelector.innerHTML = '<option value="">-- Pilih Sesi Aktif --</option>';
                if (activeSessions.length > 0) {
                    activeSessions.forEach((s, index) => {
                        sessionSelector.innerHTML += `<option value="${s.id}">Sesi #${index + 1} (${s.startTime} - ${s.endTime})</option>`;
                    });
                } else {
                    sessionSelector.innerHTML = '<option value="">Tidak ada sesi aktif saat ini</option>';
                }
            }

            sessionSelector.addEventListener('change', () => {
                const sessionId = sessionSelector.value;
                attendedThisSession = [];
                attendanceTracker = { name: null, count: 0 }; // Reset tracker saat ganti sesi
                const container = document.querySelector('#page-absensi .video-container');
                if (sessionId) {
                    startWebcam(container);
                } else {
                    stopWebcam();
                }
            });

            async function handleAutoAttendance(detection, statusUI) {
                const sessionId = sessionSelector.value;
                if (!sessionId) return;

                const sessions = getSessions();
                const selectedSession = sessions.find(s => s.id === sessionId);
                const allUsers = getRegisteredUsers();
                const participantsData = allUsers.filter(user => selectedSession.participants.includes(user.name));
                if (participantsData.length === 0) return;

                // PERBAIKAN: Gunakan semua descriptor untuk matching
                const labeledFaceDescriptors = participantsData.map(user => {
                    const descriptors = user.descriptors.map(d => new Float32Array(d));
                    return new faceapi.LabeledFaceDescriptors(user.name, descriptors);
                });
                
                // PERBAIKAN: Naikkan threshold
                const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);

                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                
                if (bestMatch.label === 'unknown') {
                    statusUI.innerText = 'Wajah tidak terdaftar dalam sesi ini.';
                    attendanceTracker = { name: null, count: 0 }; // Reset
                    return;
                }

                // Logika tracker untuk absensi stabil
                if (attendanceTracker.name === bestMatch.label) {
                    attendanceTracker.count++;
                } else {
                    attendanceTracker = { name: bestMatch.label, count: 1 };
                }

                statusUI.innerText = `Halo, ${bestMatch.label}! Tahan posisi... (${Math.round(attendanceTracker.count / ATTENDANCE_CONFIRMATION_FRAMES * 100)}%)`;

                if (attendanceTracker.count >= ATTENDANCE_CONFIRMATION_FRAMES) {
                    const user = participantsData.find(u => u.name === bestMatch.label);
                    if (user && !attendedThisSession.includes(user.name)) {
                        const attendanceStatus = recordAttendance(user, selectedSession);
                        if (attendanceStatus.status === 'success') {
                            attendedThisSession.push(user.name);
                            statusUI.innerText = `Absensi berhasil: ${user.name}`;
                            speak(`Absensi berhasil ${user.name}`);
                            attendanceTracker = { name: null, count: 0 }; // Reset setelah berhasil
                        }
                    }
                }
            }

            function recordAttendance(user, session) {
                const log = getAttendanceLog();
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const hasAttendedToday = log.some(entry => entry.name === user.name && entry.sessionId === session.id);

                if (hasAttendedToday) return { status: 'already_attended' };
                
                const deadline = new Date(`${session.date}T${session.startTime}`);
                const remark = now <= deadline ? 'Tepat Waktu' : 'Terlambat';

                log.push({ name: user.name, date: today, time: now.toLocaleTimeString('id-ID'), sessionId: session.id, remark: remark, status: 'Hadir' });
                saveAttendanceLog(log);
                return { status: 'success', remark: remark };
            }

            // --- Fungsi Daftar Peserta ---
            function displayPeserta() {
                const users = getRegisteredUsers();
                pesertaBody.innerHTML = '';
                if (users.length === 0) {
                    pesertaBody.innerHTML = `<tr><td colspan="2" class="text-center py-4">Belum ada peserta terdaftar.</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600';
                    row.innerHTML = `<td class="py-4 px-6 font-medium text-white whitespace-nowrap">${user.name}</td><td class="py-4 px-6 text-right"><button data-name="${user.name}" class="delete-user-btn font-medium text-red-500 hover:underline">Hapus</button></td>`;
                    pesertaBody.appendChild(row);
                });
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteUser(e.target.getAttribute('data-name')));
                });
            }

            function deleteUser(name) {
                if (confirm(`Apakah Anda yakin ingin menghapus peserta "${name}"? Semua data terkait akan dihapus.`)) {
                    let users = getRegisteredUsers().filter(user => user.name !== name);
                    saveRegisteredUsers(users);
                    displayPeserta();
                    speak(`${name} telah dihapus.`);
                }
            }
            
            // --- Fungsi Daftar Sesi ---
            function displaySessionList() {
                sessionListContainer.innerHTML = '';
                const sessions = getSessions().sort((a,b) => new Date(b.date) - new Date(a.date));
                if (sessions.length === 0) {
                    sessionListContainer.innerHTML = '<p class="text-gray-400 text-center">Belum ada sesi yang dibuat.</p>';
                    return;
                }
                sessions.forEach(s => {
                    const sessionElement = document.createElement('div');
                    sessionElement.className = 'bg-gray-700 p-4 rounded-lg';
                    sessionElement.innerHTML = `
                        <div class="flex justify-between items-start">
                             <div class="cursor-pointer flex-grow" data-session-id="${s.id}">
                                 <h3 class="font-bold text-lg">${s.date}</h3>
                                 <p class="text-sm text-gray-400">Jam: ${s.startTime} - ${s.endTime}</p>
                                 <p class="text-sm text-gray-400">${s.participants.length} Peserta</p>
                             </div>
                             <button data-session-id="${s.id}" class="delete-session-btn text-red-500 hover:text-red-400 font-bold p-1 text-xl">&times;</button>
                        </div>
                        <div id="detail-${s.id}" class="hidden mt-3 pt-3 border-t border-gray-600"></div>
                    `;
                    
                    sessionElement.querySelector('.cursor-pointer').addEventListener('click', (e) => {
                        const detailEl = document.getElementById(`detail-${s.id}`);
                        if (detailEl.classList.contains('hidden')) {
                            showSessionDetail(s.id, detailEl);
                            detailEl.classList.remove('hidden');
                        } else {
                            detailEl.classList.add('hidden');
                        }
                    });

                    sessionElement.querySelector('.delete-session-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSession(s.id);
                    });

                    sessionListContainer.appendChild(sessionElement);
                });
            }

            function deleteSession(sessionId) {
                if (confirm('Yakin ingin menghapus sesi ini? Semua data absensi terkait juga akan dihapus.')) {
                    let sessions = getSessions().filter(s => s.id !== sessionId);
                    saveSessions(sessions);

                    let log = getAttendanceLog().filter(l => l.sessionId !== sessionId);
                    saveAttendanceLog(log);

                    speak("Sesi telah dihapus.");
                    displaySessionList();
                }
            }

            function showSessionDetail(sessionId, detailElement) {
                const sessions = getSessions();
                const selectedSession = sessions.find(s => s.id === sessionId);
                const log = getAttendanceLog();
                const sessionLog = log.filter(l => l.sessionId === sessionId);
                
                detailElement.innerHTML = '<ul class="space-y-1"></ul>';
                const listEl = detailElement.querySelector('ul');

                selectedSession.participants.forEach(participantName => {
                    const attendanceRecord = sessionLog.find(l => l.name === participantName);
                    let status, color;
                    if (attendanceRecord) {
                        status = attendanceRecord.status;
                        color = 'text-green-400';
                    } else {
                        status = 'Tidak Hadir';
                        color = 'text-red-400';
                    }
                    listEl.innerHTML += `<li class="text-sm ${color}">${participantName}: ${status}</li>`;
                });
            }

            // --- Fungsi Grafik ---
            function displayGrafik() {
                populateGrafikSessionFilter();
                displayPerformanceRankingChart();
                displayAttendanceSummaryChart();
            }

            function populateGrafikSessionFilter() {
                const sessions = getSessions();
                const currentFilterValue = grafikSessionFilter.value;
                grafikSessionFilter.innerHTML = '<option value="all">Semua Sesi (Ringkasan)</option>';
                sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((s, index) => {
                    const optionText = `${s.date} @ ${s.startTime}`;
                    grafikSessionFilter.innerHTML += `<option value="${s.id}">${optionText}</option>`;
                });
                if (currentFilterValue) {
                    grafikSessionFilter.value = currentFilterValue;
                } else if (sessions.length > 0) {
                    grafikSessionFilter.value = sessions[0].id;
                } else {
                    grafikSessionFilter.value = 'all';
                }
            }

            function displayAttendanceSummaryChart() {
                const sessionId = grafikSessionFilter.value;
                const ctx = document.getElementById('summaryChart').getContext('2d');
                if (summaryChart) {
                    summaryChart.destroy();
                }

                if (!sessionId) return;

                const sessions = getSessions();
                const log = getAttendanceLog();
                
                let title;

                if (sessionId === 'all') {
                    title = 'Ringkasan Semua Sesi';
                } else {
                    const selectedSession = sessions.find(s => s.id === sessionId);
                    if (!selectedSession) return;
                    title = `Ringkasan Sesi: ${selectedSession.date}`;
                }

                let statusCounts = { 'Hadir': 0, 'Izin': 0, 'Sakit': 0, 'Tidak Hadir': 0 };
                
                const relevantSessions = sessionId === 'all' ? sessions : [sessions.find(s => s.id === sessionId)];
                
                relevantSessions.forEach(session => {
                    session.participants.forEach(pName => {
                        const record = log.find(l => l.sessionId === session.id && l.name === pName);
                        if (record) {
                            statusCounts[record.status]++;
                        } else {
                            statusCounts['Tidak Hadir']++;
                        }
                    });
                });

                summaryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Hadir', 'Tidak Hadir', 'Izin', 'Sakit'],
                        datasets: [{
                            data: [statusCounts.Hadir, statusCounts['Tidak Hadir'], statusCounts.Izin, statusCounts.Sakit],
                            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6', '#f59e0b'],
                            borderColor: '#4b5563',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#e5e7eb', font: { size: 14 } }
                            },
                            title: {
                                display: true,
                                text: title,
                                color: '#e5e7eb',
                                font: { size: 16 }
                            }
                        }
                    }
                });
            }

            function displayPerformanceRankingChart() {
                const users = getRegisteredUsers();
                const log = getAttendanceLog();
                performanceLeaderboardContainer.innerHTML = '';

                if (users.length === 0) {
                    performanceLeaderboardContainer.innerHTML = '<p class="text-gray-400 text-center">Belum ada peserta untuk diperingkatkan.</p>';
                    return;
                }

                const userStats = {};

                users.forEach(user => {
                    userStats[user.name] = { score: 0 };
                });

                log.forEach(entry => {
                    if (userStats[entry.name] && entry.remark === 'Tepat Waktu') {
                        userStats[entry.name].score++;
                    }
                });

                const sortedUsers = Object.keys(userStats).map(name => {
                    return { name, score: userStats[name].score };
                }).sort((a, b) => b.score - a.score);

                sortedUsers.forEach((user, index) => {
                    let cardHtml = '';
                    const rank = index + 1;
                    const scoreText = `${user.score} Poin`;

                    if (rank <= 3) {
                        const colors = {
                            1: { bg: 'bg-yellow-500/20', border: 'border-yellow-400', text: 'text-yellow-300', icon: 'ðŸ†' },
                            2: { bg: 'bg-gray-400/20', border: 'border-gray-300', text: 'text-gray-200', icon: 'ðŸ¥ˆ' },
                            3: { bg: 'bg-orange-700/20', border: 'border-orange-500', text: 'text-orange-300', icon: 'ðŸ¥‰' }
                        };
                        const c = colors[rank];
                        cardHtml = `
                            <div class="p-4 rounded-lg border ${c.bg} ${c.border} flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-4">${c.icon}</span>
                                    <div>
                                        <p class="font-bold text-lg ${c.text}">${user.name}</p>
                                        <p class="text-sm ${c.text}">${scoreText}</p>
                                    </div>
                                </div>
                                <p class="font-black text-3xl ${c.text}">#${rank}</p>
                            </div>
                        `;
                    } else {
                        cardHtml = `
                            <div class="p-3 rounded-lg bg-gray-800/50 flex items-center justify-between">
                                <div class="flex items-center">
                                    <p class="font-bold text-lg mr-4 text-gray-400">#${rank}</p>
                                    <p>${user.name}</p>
                                </div>
                                <p class="font-semibold text-gray-300">${scoreText}</p>
                            </div>
                        `;
                    }
                    performanceLeaderboardContainer.innerHTML += cardHtml;
                });
            }
            
            grafikSessionFilter.addEventListener('change', displayAttendanceSummaryChart);

            // --- Fungsi Laporan ---
            function displayLaporan() {
                const sessions = getSessions();
                
                const currentFilterValue = reportSessionFilter.value;
                reportSessionFilter.innerHTML = '<option value="">-- Pilih Sesi Laporan --</option>';
                sessions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((s, index) => {
                    const optionText = `${s.date} @ ${s.startTime} (Sesi #${sessions.length - index})`;
                    reportSessionFilter.innerHTML += `<option value="${s.id}">${optionText}</option>`;
                });
                reportSessionFilter.value = currentFilterValue;

                const selectedSessionId = reportSessionFilter.value;
                laporanBody.innerHTML = '';
                if (!selectedSessionId) {
                    laporanBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Pilih sesi untuk melihat laporan.</td></tr>`;
                    return;
                }

                const selectedSession = sessions.find(s => s.id === selectedSessionId);
                const log = getAttendanceLog();
                
                if (!selectedSession) return;

                selectedSession.participants.forEach(participantName => {
                    const attendanceRecord = log.find(l => l.name === participantName && l.sessionId === selectedSessionId);
                    let statusHtml, time, remarkHtml, actionHtml;

                    const currentStatus = attendanceRecord ? attendanceRecord.status : 'Tidak Hadir';
                    
                    if (attendanceRecord && attendanceRecord.status === 'Hadir') {
                        statusHtml = '<span class="text-green-400">Hadir</span>';
                        time = attendanceRecord.time;
                        remarkHtml = attendanceRecord.remark === 'Terlambat'
                            ? `<span class="text-yellow-400">${attendanceRecord.remark}</span>`
                            : `<span class="text-green-400">${attendanceRecord.remark}</span>`;
                    } else {
                        statusHtml = `
                            <select data-name="${participantName}" data-session-id="${selectedSessionId}" class="status-override-select bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-1">
                                <option value="Tidak Hadir" ${currentStatus === 'Tidak Hadir' ? 'selected' : ''}>Tidak Hadir</option>
                                <option value="Hadir" ${currentStatus === 'Hadir' ? 'selected' : ''}>Hadir</option>
                                <option value="Izin" ${currentStatus === 'Izin' ? 'selected' : ''}>Izin</option>
                                <option value="Sakit" ${currentStatus === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            </select>
                            <span class="status-print-only text-red-400">${currentStatus}</span>
                        `;
                        time = attendanceRecord ? attendanceRecord.time : '-';
                        remarkHtml = attendanceRecord ? `<span class="text-blue-400">${attendanceRecord.remark}</span>` : '-';
                    }
                    actionHtml = `<button data-name="${participantName}" data-session-id="${selectedSessionId}" class="delete-log-btn font-medium text-red-500 hover:underline">Hapus</button>`;
                    laporanBody.innerHTML += `<tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-600"><td class="py-4 px-6 font-medium text-white whitespace-nowrap">${participantName}</td><td class="py-4 px-6">${statusHtml}</td><td class="py-4 px-6">${time}</td><td class="py-4 px-6">${remarkHtml}</td><td class="py-4 px-6 text-right no-print">${actionHtml}</td></tr>`;
                });
            }

            function updateManualAttendance(name, sessionId, newStatus) {
                let log = getAttendanceLog();
                const sessions = getSessions();
                const selectedSession = sessions.find(s => s.id === sessionId);

                log = log.filter(entry => !(entry.name === name && entry.sessionId === sessionId));

                if (newStatus !== 'Tidak Hadir') {
                    let newEntry = {
                        name: name, date: selectedSession.date, sessionId: sessionId,
                        status: newStatus, time: '-', remark: `Manual - ${newStatus}`
                    };
                    if (newStatus === 'Hadir') {
                        newEntry.time = 'Manual';
                    }
                    log.push(newEntry);
                }
                saveAttendanceLog(log);
                displayLaporan();
            }

            function deleteAttendanceRecord(name, sessionId) {
                let log = getAttendanceLog();
                const updatedLog = log.filter(entry => !(entry.name === name && entry.sessionId === sessionId));
                saveAttendanceLog(updatedLog);
                displayLaporan();
                speak(`Absensi untuk ${name} telah dihapus.`);
            }

            laporanBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-log-btn')) {
                    const name = e.target.dataset.name;
                    const sessionId = e.target.dataset.sessionId;
                    if (confirm(`Yakin ingin menghapus absensi untuk ${name} pada sesi ini?`)) {
                        deleteAttendanceRecord(name, sessionId);
                    }
                }
            });

            laporanBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('status-override-select')) {
                    const name = e.target.dataset.name;
                    const sessionId = e.target.dataset.sessionId;
                    const newStatus = e.target.value;
                    updateManualAttendance(name, sessionId, newStatus);
                }
            });

            printLaporanBtn.addEventListener('click', () => {
                if (!reportSessionFilter.value) {
                    alert("Pilih sesi terlebih dahulu sebelum mencetak.");
                    return;
                }
                const sessionText = reportSessionFilter.options[reportSessionFilter.selectedIndex].text.split('(')[0].trim();
                document.getElementById('laporan-title').innerText = `Laporan Kehadiran: ${sessionText}`;
                window.print();
                document.getElementById('laporan-title').innerText = `Laporan Kehadiran`;
            });

            reportSessionFilter.addEventListener('change', displayLaporan);

            // --- Navigasi Halaman ---
            function switchPage(targetPageId) {
                pages.forEach(page => page.classList.add('hidden'));
                document.getElementById(targetPageId).classList.remove('hidden');
                navButtons.forEach(btn => btn.classList.replace('bg-cyan-600', 'bg-gray-700'));
                
                const navId = `nav-${targetPageId.substring(5)}`;
                const activeBtn = document.getElementById(navId);
                if(activeBtn) activeBtn.classList.replace('bg-gray-700', 'bg-cyan-600');
                
                // Reset state registrasi jika meninggalkan halaman
                isRegistrationMode = false;
                registerBtn.disabled = false;
                registerBtn.innerText = 'Mulai Registrasi';
                
                const absensiContainer = document.querySelector('#page-absensi .video-container');
                const registrasiContainer = document.querySelector('#page-registrasi .video-container');

                if (targetPageId === 'page-absensi') {
                    populateSessionSelector();
                    if (sessionSelector.value) {
                        startWebcam(absensiContainer);
                    } else {
                        stopWebcam();
                    }
                } else if (targetPageId === 'page-registrasi') {
                    startWebcam(registrasiContainer);
                } else {
                    stopWebcam();
                }

                if (targetPageId === 'page-laporan') displayLaporan();
                if (targetPageId === 'page-peserta') displayPeserta();
                if (targetPageId === 'page-sesi-list') displaySessionList();
                if (targetPageId === 'page-grafik') displayGrafik();
            }

            document.getElementById('nav-absensi').addEventListener('click', () => switchPage('page-absensi'));
            document.getElementById('nav-jadwal').addEventListener('click', () => switchPage('page-jadwal'));
            document.getElementById('nav-sesi-list').addEventListener('click', () => switchPage('page-sesi-list'));
            document.getElementById('nav-grafik').addEventListener('click', () => switchPage('page-grafik'));
            document.getElementById('nav-registrasi').addEventListener('click', () => switchPage('page-registrasi'));
            document.getElementById('nav-peserta').addEventListener('click', () => switchPage('page-peserta'));
            document.getElementById('nav-laporan').addEventListener('click', () => switchPage('page-laporan'));

            // --- Mulai Aplikasi ---
            setupPWA();
            initialize();
        });
    </script>
</body>
</html>
